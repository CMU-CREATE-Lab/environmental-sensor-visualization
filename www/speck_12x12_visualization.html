<!DOCTYPE html>
<html>
<head>
   <title>Speck 12x12 Grid Test</title>
   <link href="css/main.css" rel="stylesheet">
   <style type="text/css">

      #dateAxisContainer {
         border-top: 1px solid black;
      }

      .gridRow {
         display: table-row;
      }

      .cellHighlight {
         outline: 2px solid red;
      }

      .gridCell {
         display: table-cell;
         width: 25px;
         height: 25px;
         min-width: 25px;
         min-height: 25px;
         max-width: 25px;
         max-height: 25px;
         border: 1px solid rgba(0, 0, 0, 0.5);
         cursor: pointer;
      }
   </style>
   <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
   <script src="lib/handlebars.js"></script>
   <script src="lib/moment.min.js"></script>
   <script src="lib/commons-javascript/org/cmucreatelab/util/Arrays.js"></script>
   <script src="lib/commons-javascript/org/cmucreatelab/util/Http.js"></script>
   <script src="js/org/bodytrack/grapher/gwt/grapher2.nocache.js"></script>
   <script src="js/org/bodytrack/grapher/MultiplotGrapher.js"></script>
   <script src="js/org/cmucreatelab/visualization/DataManager.js"></script>
   <script src="js/org/cmucreatelab/visualization/speck/SpeckDevices.js"></script>
   <script language="JavaScript" type="text/javascript">

      var NUM_ROWS = 12;
      var NUM_COLS = 12;

      var METADATA_URL = "data/speck_12x12_metadata.json";
      var DATA_URL = "data/speck_12x12_data.bin";

      var TIMESTAMP_FORMAT = "YYYY-MM-DD HH:mm:ss";
      var TIMESTAMP_FORMAT_SHORT = "HH:mm:ss";

      var MIN_PARTICLES = 0;
      var MAX_PARTICLES = 5000;
      var HSL_RED = 0;
      var HSL_GREEN = 120;

      var deviceNameGrid = [];

      var dataManager = null;

      var channelInfoTemplate = null;
      var yAxisTemplate = null;
      var yAxisColorTemplate = null;
      var yAxisInfoTemplate = null;
      var dateAxis;
      var grapher;
      var plotContainer;

      var currentlySelectedCells = {};
      var numCurrentlySelectedCells = 0;
      var availablePlotColors = ["#990000", "#009900", "#000099", "#999900", "#990099", "#999999", "#009999", "#6600ff", "#ff0066"];
      var MAX_NUM_SELECTED_CELLS = availablePlotColors.length;
      var usedPlotColorsByDeviceId = {};

      var globalTimeRange = null;
      var isPlaying = false;
      var timeoutHandle = null;
      var t = null;

      var isAutoScaleOn = false;

      window.grapherLoad = loadData;

      function loadData() {
         $.ajax({
                   url : METADATA_URL,
                   type : 'GET',
                   dataType : 'json',
                   timeout : 5000,
                   cache : false,
                   global : false,
                   success : function(devicesMetadata) {
                      if (devicesMetadata && devicesMetadata['devices']) {

                         $.each(devicesMetadata['devices'],
                                function(index, device) {
                                   var row = device['row'];
                                   var col = device['col'];
                                   if (typeof deviceNameGrid[row] === 'undefined') {
                                      deviceNameGrid[row] = [];
                                   }
                                   deviceNameGrid[row][col] = device['name'];
                                });

                         loadBinaryData(devicesMetadata);
                      }
                      else {
                         console.log("Failed to load " + METADATA_URL);
                      }
                   },
                   error : function() {
                      console.log("Failed to load " + METADATA_URL);
                   }
                });

      }

      function loadBinaryData(devicesMetadata) {
         org.cmucreatelab.util.Http.loadArrayBuffer(DATA_URL,
                                                    {
                                                       success : function(arrayBuffer) {
                                                          console.log("loadArrayBuffer SUCCESS!");
                                                          var devices = new org.cmucreatelab.visualization.speck.SpeckDevices(devicesMetadata, arrayBuffer);
                                                          dataManager = new org.cmucreatelab.visualization.DataManager(devices);

                                                          // now that all the data is loaded, go ahead and initialize the page
                                                          initialize();
                                                       },
                                                       failure : function(requestStatus) {
                                                          // TODO: do something better
                                                          alert("Failed to load the data from [" + DATA_URL + "] (Request Status: " + requestStatus + ")");
                                                       }
                                                    });
      }

      function initialize() {
         $("#loading_panel").hide();
         $("#main_panel").show();

         initializeGrid();

         // compile the templates for later use
         channelInfoTemplate = Handlebars.compile($("#channel_info_template").html());
         yAxisTemplate = Handlebars.compile($("#y_axis_template").html());
         yAxisColorTemplate = Handlebars.compile($("#y_axis_color_template").html());
         yAxisInfoTemplate = Handlebars.compile($("#y_axis_info_template").html());

         // configure the DataManager
         dataManager.addDataChangeListener(function(valuesMap) {
            $.each(valuesMap, function(name, value) {
               $("#" + name).css("background-color", (value === null) ? "white" : getColorForValue(value));
            });
         });

         // initialize the DateAxis, Grapher, and PlotContainer
         globalTimeRange = dataManager.getGlobalTimeRange();
         dateAxis = new DateAxis("dateAxis", "horizontal", {"min" : globalTimeRange['min'], "max" : globalTimeRange['max']});
         dateAxis.addAxisChangeListener(function(cursorChangeEvent) {
            // set the animation time here so that the user can click the plot to affect the animation playback position
            t = cursorChangeEvent['cursorPosition'];
            displayAnimationTime(t);

            // notify the data manager of the axis change
            dataManager.setTimeRange({
                                        "min" : cursorChangeEvent['min'],
                                        "max" : cursorChangeEvent['max'],
                                        "cursorPosition" : cursorChangeEvent['cursorPosition']
                                     });

            // auto-scale the y-axes
            if (isAutoScaleOn) {
               autoScaleYAxes();
            }
         });

         grapher = new org.bodytrack.grapher.MultiplotGrapher(dateAxis);
         plotContainer = new PlotContainer("pc1", false, []);

         // show the grapher area
         $("#grapher_area").show();

         setSizes();

         dateAxis.setCursorPosition(globalTimeRange['min']);

         // call setSizes() again to fix the layout
         setSizes();

         // set up window resize handler
         $(window).resize(setSizes);
      }

      function initializeGrid() {
         // compile the templates for later use
         var gridRowTemplate = Handlebars.compile($("#grid_row_template").html());
         var gridCellTemplate = Handlebars.compile($("#grid_cell_template").html());

         var gridArea = $("#gridArea");

         for (var rowNum = 0; rowNum < NUM_ROWS; rowNum++) {
            var row = $(gridRowTemplate());

            for (var colNum = 0; colNum < NUM_COLS; colNum++) {
               var id = deviceNameGrid[rowNum][colNum];
               var cell = $(gridCellTemplate({ id : id, prettyName : dataManager.findByName(id)['prettyName'] }));
               cell.mouseenter(function() {
                  $(this).addClass("cellHighlight")
               });
               cell.mouseleave(function() {
                  $(this).removeClass("cellHighlight")
               });
               cell.click(function() {
                  // if the selected cell is already selected, then remove it
                  if (currentlySelectedCells.hasOwnProperty(this.id)) {
                     setCellSelected(this.id, currentlySelectedCells[this.id], false);
                  }
                  else {
                     if (numCurrentlySelectedCells < MAX_NUM_SELECTED_CELLS) {
                        setCellSelected(this.id, $("#" + this.id), true);
                     }
                  }
               });

               row.append(cell);
            }

            gridArea.append(row);
         }
      }

      function setCellSelected(id, cell, isSelected) {
         cell.css("outline", isSelected ? "2px solid black" : "none")

         if (isSelected) {
            currentlySelectedCells[id] = cell;
         }
         else {
            delete currentlySelectedCells[id];
         }
         numCurrentlySelectedCells = numCurrentlySelectedCells + (isSelected ? 1 : -1);

         // finally, add or remove the channel as appropriate
         (isSelected) ? loadChannel(id) : removeChannel(id);
      }

      function getColorForValue(value) {
         return 'hsl(' + getColorHue(value) + ',100%,50%)';
      }

      function getColorHue(valRaw) {
         var val = Math.min(Math.max(valRaw, MIN_PARTICLES), MAX_PARTICLES);
         var percentage = val / MAX_PARTICLES;
         return Math.round(HSL_GREEN - (HSL_GREEN * percentage));
      }

      function removeChannel(id) {
         var plot = grapher.getPlot(id);
         if (typeof plot !== 'undefined' && plot != null) {
            plotContainer.removePlot(plot);
         }
         grapher.removePlot(id);
         $("#" + getYAxisElementId(id) + "_container").remove();
         $("#" + getYAxisElementId(id) + "_color_container").remove();
         $("#" + getYAxisElementId(id) + "_info_container").remove();
         $("#" + getYAxisElementId(id) + "_channel_info_container").remove();
         returnPlotColor(id);

         if (numCurrentlySelectedCells <= 0) {
            $("#grapherContainer").hide();
            $("#channelInfosContainer").hide();
            $("#axisControls").hide();
         }
         setSizes();
      }

      function reservePlotColor(id) {
         var color = availablePlotColors.splice(0, 1)[0];
         usedPlotColorsByDeviceId[id] = color;
         return color;
      }

      function returnPlotColor(id) {
         availablePlotColors.push(usedPlotColorsByDeviceId[id]);
         delete usedPlotColorsByDeviceId[id];
      }

      function getYAxisElementId(id) {
         // WARNING! This assumes that the id has no spaces and that the
         // line below will produce a legal value for a DOM element id
         return  "yAxis" + id;
      }

      function loadChannel(id) {
         console.log("loadChannel(" + id + ")");

         var device = dataManager.findByName(id);

         var yAxisElementId = getYAxisElementId(id);
         var plotColor = reservePlotColor(id);

         $("#yAxes").append(yAxisTemplate({"yAxisElementId" : yAxisElementId}));
         $("#yAxesColor").append(yAxisColorTemplate({"yAxisElementId" : yAxisElementId, color : plotColor}));
         $("#yAxesInfo").append(yAxisInfoTemplate({"yAxisElementId" : yAxisElementId}));
         $("#channelInfos").append(channelInfoTemplate({
                                                          "yAxisElementId" : yAxisElementId,
                                                          device : device,
                                                          color : plotColor,
                                                          minValueTimeFormatted : moment.unix(device['minValueTime']).format(TIMESTAMP_FORMAT_SHORT),
                                                          maxValueTimeFormatted : moment.unix(device['maxValueTime']).format(TIMESTAMP_FORMAT_SHORT)
                                                       }));
         $("#" + yAxisElementId + "_channel_info_close_button").click(function() {
            setCellSelected(id, currentlySelectedCells[id], false)
         });

         var channelDatasource = dataManager.getChannelDatasource(id);
         var channel = {
            "min" : device['minValue'],
            "max" : device['maxValue'],
            "style" : {
               "styles" : [
                  {"type" : "line", "lineWidth" : 1, "show" : true, color : plotColor}
               ],
               highlight : {
                  "lineWidth" : 1,
                  "styles" : [
                     {
                        "type" : "lollipop",
                        "color" : "#000000",
                        "radius" : 1,
                        "lineWidth" : 1,
                        "fill" : false
                     },
                     {
                        "show" : true,
                        "type" : "value",
                        "fillColor" : "#000000",
                        "marginWidth" : 10,
                        "font" : "7pt Helvetica,Arial,Verdana,sans-serif",
                        "verticalOffset" : 7,
                        "numberFormat" : "###,##0"
                     }
                  ]
               }
            }
         };
         grapher.addPlot(id, channel, channelDatasource, yAxisElementId);
         grapher.addDataPointListener(id, displayTimeForDataPoint);
         grapher.addDataPointListener(id, function(val) {
            displayValueForDataPoint(id, val ? val['value'] : null);
         });
         plotContainer.addPlot(grapher.getPlot(id));

         $("#grapherContainer").show();
         $("#channelInfosContainer").show();
         $("#axisControls").show();

         setSizes();
      }

      function displayValueForDataPoint(id, val) {
         var yAxisElementId = getYAxisElementId(id);
         if (val) {
            $("#" + yAxisElementId + "_valueLabelText").show().html(val);
            $("#" + yAxisElementId + "_valueLabelColor").show().css('background-color', getColorForValue(val));
         }
         else {
            $("#" + yAxisElementId + "_valueLabelText").hide();
            $("#" + yAxisElementId + "_valueLabelColor").hide();
         }
      }

      function displayTimeForDataPoint(val) {
         $("#timeLabel").html(val ? moment.unix(val['date']).format(TIMESTAMP_FORMAT) : "");
      }

      function displayAnimationTime(val) {
         $("#animationTimeLabel").html(val ? moment.unix(val).format(TIMESTAMP_FORMAT) : "");
      }

      function setSizes() {
         var plotContainerWidth = $(window).width() - 20 - Math.max($("#yAxesTable").width(), $("#axisControls").width()) - 2;
         var plotContainerHeight = $("#column0").height() - 2;

         // resize date axis, plot container, and y axes
         dateAxis.setSize(plotContainerWidth, $("#dateAxis").height(), SequenceNumber.getNext());
         plotContainer.setSize(plotContainerWidth, plotContainerHeight, SequenceNumber.getNext());
         grapher.updateYAxesSizes();
         $(".channelInfo").width(plotContainerWidth / MAX_NUM_SELECTED_CELLS);
      }

      function jumpToTime(time) {
         var dateAxisHalfRange = (dateAxis.getMax() - dateAxis.getMin()) / 2;
         dateAxis.setCursorPosition(time);
         dateAxis.setRange(time - dateAxisHalfRange, time + dateAxisHalfRange);
      }

      function play() {
         if (!isPlaying) {
            isPlaying = true;
            t = dateAxis.getMin();
            $("#playButton").val("Stop");
            computeAndRenderNextGeneration();
         }
         else {
            isPlaying = false;
            $("#playButton").val("Play");
            window.clearTimeout(timeoutHandle);
            timeoutHandle = null;
         }
      }

      function computeAndRenderNextGeneration() {
         if (t < dateAxis.getMax()) {
            t += parseInt($("#playbackStepIntervalSecs").val());
            if (t < dateAxis.getMax()) {
               dateAxis.setCursorPosition(t);
            }
            else {
               dateAxis.setCursorPosition(dateAxis.getMax());
               play();
            }
         }
         else {
            dateAxis.setCursorPosition(dateAxis.getMax());
            play();
         }

         if (isPlaying) {
            window.clearTimeout(timeoutHandle);
            timeoutHandle = window.setTimeout(computeAndRenderNextGeneration, $("#animationIntervalMillis").val());
         }
      }

      function resetDateAxis() {
         dateAxis.setRange(globalTimeRange['min'], globalTimeRange['max']);
      }

      function unifyYAxes() {
         var min = Number.MAX_VALUE;
         var max = Number.MIN_VALUE;
         grapher.forEachPlot(function(plot) {
            var stats = plot.getStatistics(dateAxis.getMin(), dateAxis.getMax());
            min = Math.min(min, stats['y_min']);
            max = Math.max(max, stats['y_max']);
         });

         var paddedRange = paddedYAxisRange(min, max);

         grapher.forEachPlot(function(plot, yAxis) {
            yAxis.setRange(paddedRange['min'], paddedRange['max']);
         });
      }

      function autoScaleYAxes() {
         grapher.forEachPlot(function(plot, yAxis) {
            var stats = plot.getStatistics(dateAxis.getMin(), dateAxis.getMax());
            var paddedRange = paddedYAxisRange(stats['y_min'], stats['y_max']);
            yAxis.setRange(paddedRange['min'], paddedRange['max']);
         });
      }

      function autoScaleLockChange() {
         isAutoScaleOn = $("#autoScaleLockCheckbox").is(":checked");
         if (isAutoScaleOn) {
            $("#autoScaleYAxesButton").attr("disabled", "disabled");
         }
         else {
            $("#autoScaleYAxesButton").removeAttr("disabled");
         }
      }

      function paddedYAxisRange(min, max) {
         var yDiff = max - min;
         var padding = 0.5;
         if (yDiff < 1e-10) {
            padding = 0.5;
         }
         else {
            padding = 0.05 * yDiff;
         }
         return {min : min - padding, max : max + padding}
      }

      function removeAllSelections() {
         for (var id in currentlySelectedCells) {
            var cell = currentlySelectedCells[id];
            setCellSelected(id, cell, false);
         }
      }
   </script>

   <script id="grid_row_template" type="text/x-handlebars-template">
      <div class="gridRow"></div>
   </script>

   <script id="grid_cell_template" type="text/x-handlebars-template">
      <div id="{{id}}" class="gridCell" title="Speck {{prettyName}}"></div>
   </script>

   <script id="y_axis_template" type="text/x-handlebars-template">
      <td id="{{yAxisElementId}}_container" class="axisCell">
         <div class="yAxisContainer">
            <div id="{{yAxisElementId}}" class="yAxis"></div>
         </div>
      </td>
   </script>

   <script id="y_axis_color_template" type="text/x-handlebars-template">
      <td id="{{yAxisElementId}}_color_container">
         <div class="yAxisColor" style="background-color:{{color}}"></div>
      </td>
   </script>

   <script id="y_axis_info_template" type="text/x-handlebars-template">
      <td id="{{yAxisElementId}}_info_container">
         <table border="0" cellpadding="0" cellspacing="0" align="right">
            <tr>
               <td>
                  <div id="{{yAxisElementId}}_valueLabelText" class="valueLabelText"></div>
               </td>
               <td>
                  <div id="{{yAxisElementId}}_valueLabelColor" class="valueLabelColor"></div>
               </td>
            </tr>
         </table>
      </td>
   </script>

   <script id="channel_info_template" type="text/x-handlebars-template">
      <div id="{{yAxisElementId}}_channel_info_container" class="channelInfo">
         <div class="yAxisColor" style="background-color:{{color}};border-right:none"></div>
         <div id="{{yAxisElementId}}_channel_info_close_button" class="closeButton" style="float:right;margin-right:3px"></div>
         <div class="deviceName" style="margin-left:3px"><b>Speck {{device.prettyName}}</b></div>
         <div style="padding:3px">
            <table border="0" cellpadding="0" cellspacing="0" align="center">
               <tr>
                  <th class="channelInfoLabel">Min</th>
                  <th rowspan="3">&nbsp;&nbsp;&nbsp;</th>
                  <th class="channelInfoLabel">Max</th>
               </tr>
               <tr align="center">
                  <td><a href="#" onclick="jumpToTime({{device.minValueTime}}); return false;">{{device.minValue}}</a></td>
                  <td><a href="#" onclick="jumpToTime({{device.maxValueTime}}); return false;">{{device.maxValue}}</a></td>
               </tr>
               <tr align="center">
                  <td><a href="#" onclick="jumpToTime({{device.minValueTime}}); return false;">{{minValueTimeFormatted}}</a></td>
                  <td><a href="#" onclick="jumpToTime({{device.maxValueTime}}); return false;">{{maxValueTimeFormatted}}</a></td>
               </tr>
            </table>
         </div>
      </div>
   </script>
</head>
<body>

<div id="loading_panel">Loading...</div>
<div id="main_panel">
   <div id="grapher_area" class="textSelectionDisabled">
      <table border="0" cellpadding="0" cellspacing="0">
         <tr valign="bottom">
            <td>
               <div id="gridArea"></div>
            </td>
            <td>
               <table border="0" cellpadding="0" cellspacing="0" align="center" style="margin:5px">
                  <tr>
                     <td><input id="playButton" type="button" onclick="play()" value="Play" style="margin-right:15px"></td>
                     <td>step</td>
                     <td>
                        <select id="playbackStepIntervalSecs">
                           <option value="1">1 second</option>
                           <option value="2">2 seconds</option>
                           <option value="5">5 seconds</option>
                           <option value="10">10 seconds</option>
                           <option value="30">30 seconds</option>
                           <option value="60">1 minute</option>
                           <option value="300">5 minutes</option>
                        </select>
                     </td>
                     <td>every</td>
                     <td>
                        <select id="animationIntervalMillis">
                           <option value="1000">1</option>
                           <option value="500">1/2</option>
                           <option value="200">1/5</option>
                           <option value="100" selected="selected">1/10</option>
                           <option value="50">1/20</option>
                           <option value="10">1/100</option>
                        </select>
                     </td>
                     <td>second</td>
                  </tr>
                  <tr>
                     <td colspan="3">
                        <div id="animationTimeLabel" style="text-align: left; margin-left:3px"></div>
                     </td>
                     <td colspan="3" align="right">
                        <input id="resetDateAxisButton" type="button" onclick="resetDateAxis()" value="Reset Time Range"><br>
                     </td>
                  </tr>
               </table>
            </td>
         </tr>
      </table>
      <table border="0" cellpadding="0" cellspacing="0">
         <tr>
            <td width="400">
               <div id="dateAxisContainer">
                  <div id="dateAxis"></div>
               </div>
            </td>
            <td>
               <table id="axisControls" border="0" cellpadding="0" cellspacing="0" style="display:none;margin-left:5px">
                  <tr>
                     <td>
                        <input id="unifyYAxesButton" type="button" onclick="unifyYAxes()" value="Unify Y-Axis Ranges">
                     </td>
                  </tr>
                  <tr>
                     <td>
                        <input id="autoScaleYAxesButton" type="button" onclick="autoScaleYAxes()" value="Auto Scale">
                        <input id="autoScaleLockCheckbox" name="autoScaleLockCheckbox" type="checkbox" onchange="autoScaleLockChange()" value="true">Lock
                     </td>
                  </tr>
               </table>
            </td>
         </tr>
         <tr id="grapherContainer" style="display:none">
            <td id="column0">
               <div id="plotContainer1" class="plotContainer">
                  <div id="pc1" class="plot"></div>
               </div>
            </td>
            <td rowspan="2" valign="top">
               <table id="yAxesTable" border="0" cellpadding="0" cellspacing="0">
                  <tr id="yAxes"></tr>
                  <tr id="yAxesColor"></tr>
                  <tr id="yAxesInfo"></tr>
               </table>
               <div id="timeLabel" style="text-align: center"></div>
            </td>
         </tr>
         <tr id="channelInfosContainer" valign="top" style="display:none">
            <td>
               <div id="channelInfos" style="display: table-row"></div>
               <input id="removeAllSelectionsButton" type="button" onclick="removeAllSelections()" value="Remove All" style="margin-top:5px">
            </td>
         </tr>
      </table>
   </div>
</div>
</body>
</html>